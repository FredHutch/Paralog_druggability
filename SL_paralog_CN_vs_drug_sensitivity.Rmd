---
title: "pgPEN_DeKegel_comparison"
author: "Phoebe Parrish"
date: "2022-01-07"
output: html_document
---

## To Do
* update depmap version - use more recent data (I am currently using 19Q1)
* CN as continuous variable, look at outliers (not top 2 quartiles)

## Setup

```{r setup, include=FALSE}

library(biomaRt)
library(depmap)
library(ExperimentHub)
library(tidyverse)
library(ggrepel)
library(ggforce)
library(ggsignif)
library(RColorBrewer)
library(ggpubr) # another way to do significance bars
library(ggprism) # another significance bar package...

```


### Assign variables
```{r}

date <- Sys.Date()

## work laptop
base_dir <- file.path("/Users", "pparrish", "Google_Drive", "01_Research", "01_Projects", "01_Paralog_pgRNA",
                      "01_Data", "Paralog_SL_meta_analysis")

## personal laptop
# base_dir <- file.path("/Users", "phoebeparrish", "Google_Drive", "01_Research", "01_Projects", "01_Paralog_pgRNA",
#                       "01_Data", "Paralog_SL_meta_analysis")

in_dir <- file.path(base_dir, "01_input_files")

out_dir <- file.path(base_dir, "02_output_files")


```


### Import files

```{r, message = FALSE}

d.DeKegel <- read_csv(file.path(in_dir, "DeKegel_Table_S8.csv"))

d.Parrish <- read_rds(file.path(in_dir, "d.PC9_v_HeLa_paralog_target_GI_wide_flag"))

d.Parrish_DeKegel

d.Dede <- read_tsv(file.path(in_dir, "Dede_Table_S2.txt"))

d.druggable <- read_tsv(file.path(in_dir, "finan_druggability_with_ensembl_id.txt"))

d.Broad_drug_info <- read_csv(file.path(in_dir, "primary-screen-replicate-collapsed-treatment-info.csv"))

d.Broad_secondary_auc <- read_csv(file.path(in_dir, "secondary-screen-dose-response-curve-parameters.csv"))

d.Broad_secondary_doses <- read_csv(file.path(in_dir, "secondary-screen-dose-response-curve-parameters.csv"))

```



```{r}

## 21Q2 datasets
metadata <- read_rds(file.path(out_dir, "d.metadata_21Q2"))
d.expr_top5 <- read_rds(file.path(out_dir, "d.expr_21Q2_DeKegel_top5"))
d.expr_top5_drug <- read_rds(file.path(out_dir, "d.expr_21Q2_DeKegel_top5_druggable"))
d.cn_top5 <- read_rds(file.path(out_dir, "d.cn_21Q2_DeKegel_top5"))
d.cn_top5_drug <- read_rds(file.path(out_dir, "d.cn_21Q2_DeKegel_top5_druggable"))
d.mut_top5 <- read_rds(file.path(out_dir, "d.mut_21Q2_DeKegel_top5"))
d.mut_top5_drug <- read_rds(file.path(out_dir, "d.mut_21Q2_DeKegel_top5_druggable"))

## 19Q3 datasets
drug_metadata <- read_rds(file.path(out_dir, "d.metadata_19Q3"))
d.drug_sens_filtered <- read_rds(file.path(out_dir, "d.drug_sens_19Q3_DeKegel_top5_druggable"))

```

## Analysis

#### CN vs. drug sensitivity
# Remove starting here?
```{r}

# ## join tbls together
# 
# ## get useful DepMap CN information
# metadata
# d.cn_top5_drug
# 
# d.tmp <- metadata %>%
#   dplyr::select(depmap_id, stripped_cell_line_name, primary_disease,
#                 subtype_disease, lineage, lineage_subtype) %>%
#   right_join(d.cn_top5_drug, by = "depmap_id") %>% # gets rid of cell lines with no CN data
#   dplyr::select(-cell_line) %>%
#   rename(cell_line = stripped_cell_line_name)
# d.tmp
# 
# d.DeKegel_top5_druggable
# 
# ## pivot DF longer so each gene in a pair is its own row
# d.DeKegel_top5_druggable_genes <- d.DeKegel_top5_druggable %>%
#   rename(A1_hgnc = A1, A2_hgnc = A2) %>%
#   pivot_longer(cols = starts_with("A"),
#                names_to = c("gene", ".value"),
#                names_pattern = "A(.)_(.*)") %>%
#   dplyr::select(prediction_rank:sorted_gene_pair,
#                 gene:drug_tier, 
#                 ensembl_pair:top_5_SL_all_screens)
# d.DeKegel_top5_druggable_genes
# 
# ## add cell line, CN information to top SL and druggable paralog pair df
# d.DeKegel_top5_druggable_genes_depmap_cn <- d.DeKegel_top5_druggable_genes %>%
#   right_join(d.tmp, by = c("entrez" = "entrez_id")) 
# d.DeKegel_top5_druggable_genes_depmap_cn





```



```{r}

# ## make df to get A1 DepMap CN info
# d.DeKegel_top5_druggable
# d.tmp2 <- d.tmp %>%
#   dplyr::select(-c(gene, gene_name))
# d.tmp2
# 
# ## make df to add A2 DepMap CN info
# d.tmp3 <- d.tmp2 %>%
#   dplyr::select(depmap_id, entrez_id, log_copy_number) %>%
#   unite(depmap_entrez_id, c(depmap_id, entrez_id), sep = "_")
# d.tmp3
# 
# ## add cell line, CN info for each paralog to wide paralog DF
# d.DeKegel_top5_druggable_depmap_cn <- d.DeKegel_top5_druggable %>%
#   right_join(d.tmp2, by = c("A1_entrez" = "entrez_id")) %>%
#   rename(A1_log_cn = log_copy_number) %>%
#   unite(depmap_entrez_id, c(depmap_id, A2_entrez), sep = "_", remove = FALSE) %>% ## create new id column
#   left_join(d.tmp3, by = "depmap_entrez_id") %>%
#   rename(A2_log_cn = log_copy_number)
# d.DeKegel_top5_druggable_depmap_cn

```

```{r}

drug_metadata
d.drug_sens_filtered

## expand df so each drug target is its own row
d.drug_sens_filtered_target <- d.drug_sens_filtered %>%
  separate_rows(target)
d.drug_sens_filtered_target

```


```{r}

### Adding CN info to top 5% of SL pairs from De Kegel paper
### Same as above 3 chunks but for all top 5% genes (no druggability filter)
# d.DeKegel_top5_druggable

d.DeKegel_top5 <- d.DeKegel %>%
  filter(prediction_percentile < 5)
d.DeKegel_top5

d.tmp <- metadata %>%
  ungroup() %>%
  dplyr::select(depmap_id, stripped_cell_line_name, primary_disease,
                subtype_disease, lineage, lineage_subtype) %>%
  right_join(d.cn_top5_drug, by = "depmap_id") %>% # gets rid of cell lines with no CN data
  dplyr::select(-c(cell_line, gene)) %>%
  rename(cell_line = stripped_cell_line_name)
d.tmp

d.DeKegel_top5_genes <- d.DeKegel_top5 %>%
  rename(A1_hgnc = A1, A2_hgnc = A2) %>%
  pivot_longer(cols = starts_with("A"),
               names_to = c("gene_pos", ".value"),
               names_pattern = "A(.)_(.*)") %>%
  dplyr::select(prediction_rank:sorted_gene_pair,
                gene_pos:ensembl,
                ensembl_pair:family_size)
d.DeKegel_top5_genes


## add cell line, CN information to top 5% predicted SL pair df
d.DeKegel_top5_genes_depmap_cn <- d.DeKegel_top5_genes %>%
  right_join(d.tmp, by = c("entrez" = "entrez_id")) %>%
  rename(log_cn = log_copy_number)
d.DeKegel_top5_genes_depmap_cn


d.DeKegel_top5_genes_depmap_cn <- d.DeKegel_top5_genes_depmap_cn %>%
  group_by(sorted_gene_pair, gene_name) %>%
  mutate(cn_bin = ntile(log_cn, n = 4)) %>%
  mutate(cn_bin = factor(cn_bin, levels = c(4, 3, 2, 1))) %>%
  ungroup()
d.DeKegel_top5_genes_depmap_cn


# d.DeKegel_top5_druggable_depmap_cn

## checking that it works
# d.DeKegel_top5_genes_depmap_cn %>%
#   filter(sorted_gene_pair == "HDAC1_HDAC2") %>%
#   filter(cell_line == "NIHOVCAR3")

## calculate CN ntiles


```

If I filter for the top 5th percentile of genes, I get 1,795 rows vs. 391 if we filter for Finan 2017 druggable *and* top 5th percentile. 


```{r}


## add DepMap drug sensitivity info

# drug_metadata
# d.drug_sens_filtered

## expand df so each drug target is its own row
d.drug_sens_filtered_target <- d.drug_sens_filtered %>%
  separate_rows(target) %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, name, dose, moa, target) %>%
  rename(compound_name = name)
d.drug_sens_filtered_target

d.DeKegel_top5_genes_depmap_cn_drug <- left_join(d.DeKegel_top5_genes_depmap_cn, 
                                                 d.drug_sens_filtered_target,
                                                 by = c("depmap_id" = "depmap_id", "gene_name" = "target"))
d.DeKegel_top5_genes_depmap_cn_drug


## CHECK THAT THIS ACTUALLY WORKED!!!!

```

# move down from here?

```{r}


# d.tmp1_A1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) 
# 
# d.tmp1_A2 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) 
#   
# d.tmp2 <- d.drug_sens_filtered_target %>%
#   # filter(target == "CDK19" | target == "CDK8") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line)) #%>%
#   # rename(compound_name = name)
# 
# d.DeKegel_top5_cn_drug_A1 <- left_join(d.tmp1_A1, d.tmp2, by = c("cell_line_gene1" = "cell_line_gene")) %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene1) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A1


## pivot wider
# d.DeKegel_top5_genes_depmap_cn %>%
#   pivot_wider(names_from = gene_pos,
#               names_glue = "A{gene_pos}_{.value}",
#               values_from = c(hgnc:ensembl, log_cn, gene_name))

## calculate combined CN, combined CN quartiles
## remove duplicate rows for drugs that target both paralogs

```



```{r}

## add drug info


```


```{r}

## calculate ntiles
# 
# d.DeKegel_top5_druggable_depmap_cn <-  d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   # unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) %>%
#   group_by(sorted_gene_pair) %>%
#   mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
#          A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
#   mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
#          A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1))) %>%
#   dplyr::select(-c(prediction_score:top_5_percent))

```


```{r}

## combine DFs 
# 
# d.tmp1_A1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) 
# 
# d.tmp1_A2 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) 
#   
# d.tmp2 <- d.drug_sens_filtered_target %>%
#   # filter(target == "CDK19" | target == "CDK8") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line)) #%>%
#  # rename(compound_name = name)
# 
# d.DeKegel_top5_cn_drug_A1 <- left_join(d.tmp1_A1, d.tmp2, by = c("cell_line_gene1" = "cell_line_gene")) %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene1) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A1
# 
# d.DeKegel_top5_cn_drug_A2 <- left_join(d.tmp1_A2, d.tmp2, by = c("cell_line_gene2" = "cell_line_gene"))  %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene2) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A2



```







```{r}

# drug_metadata
# d.drug_sens_filtered
# 
# ## expand df so each drug target is its own row
# d.drug_sens_filtered_target <- d.drug_sens_filtered %>%
#   separate_rows(target)
# d.drug_sens_filtered_target

```

```{r}

## join drug data and CN/SL DFs

# d.DeKegel_top5_druggable_depmap_cn

## test case using CDK8/CDK19

# d.test1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) %>%
#   group_by(sorted_gene_pair) %>%
#   mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
#          A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
#   mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
#          A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1)))
#   
# d.test2 <- d.drug_sens_filtered_target %>%
#   filter(target == "CDK19" | target == "CDK8") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, name, dose, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line))
# 
# d.test <- left_join(d.test1, d.test2, by = c("cell_line_gene2" = "cell_line_gene"))
# d.test
# 
# d.test %>%
#   filter(!is.na(dependency)) %>%
#   ungroup() %>%
#   ggplot(aes(x = A1_cn_bin, y = dependency, fill = A1_cn_bin)) +
#   geom_boxplot() +
#   theme_bw() +
#   theme(aspect.ratio = 0.75,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap(~name, scales = "free_y")

```



```{r}

## test case using PAK1/PAK2

# d.test1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   filter(sorted_gene_pair == "PAK1_PAK2") %>%
#   unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) %>%
#   group_by(sorted_gene_pair) %>%
#   mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
#          A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
#   mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
#          A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1)))
#   
# d.test2 <- d.drug_sens_filtered_target %>%
#   filter(target == "PAK1" | target == "PAK2") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, name, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line))
# 
# d.test <- left_join(d.test1, d.test2, by = c("cell_line_gene1" = "cell_line_gene"))
# d.test
# 
# d.test %>%
#   filter(!is.na(dependency)) %>%
#   ungroup() %>%
#   ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   theme_bw() +
#   theme(aspect.ratio = 0.75,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap(~name, scales = "free_y")
# 
# d.test %>%
#   filter(A2_cn_bin %in% c(1, 4)) %>%
#   summarize("pval" = wilcox.test(dependency ~ A2_cn_bin, alternative = "greater")$p.value)
  
```
##### Make DFs
```{r}

## calculate ntiles

# d.DeKegel_top5_druggable_depmap_cn <-  d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   # unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) %>%
#   group_by(sorted_gene_pair) %>%
#   mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
#          A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
#   mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
#          A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1))) %>%
#   dplyr::select(-c(prediction_score:top_5_percent))

```


```{r}

# ## combine DFs 
# 
# d.tmp1_A1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) 
# 
# d.tmp1_A2 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) 
#   
# d.tmp2 <- d.drug_sens_filtered_target %>%
#   # filter(target == "CDK19" | target == "CDK8") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line)) #%>%
#   # rename(compound_name = name)
# 
# d.DeKegel_top5_cn_drug_A1 <- left_join(d.tmp1_A1, d.tmp2, by = c("cell_line_gene1" = "cell_line_gene")) %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene1) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A1
# 
# d.DeKegel_top5_cn_drug_A2 <- left_join(d.tmp1_A2, d.tmp2, by = c("cell_line_gene2" = "cell_line_gene"))  %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene2) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A2

```

# Remove ending here? 

##### WRST
```{r}

d.DeKegel_top5_cn_drug_A1 %>%
  filter(sorted_gene_pair == "ABCB6_ABCB7") %>%
  filter(A2_cn_bin %in% c(1, 4)) %>%
  group_by(A2_cn_bin) 

d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_summary <- d.DeKegel_top5_cn_drug_A1 %>%
  filter(A2_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A2_cn_bin, alternative = "greater")$p.value) 
d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_summary

d.DeKegel_top5_cn_drug_A1_pval <- left_join(d.DeKegel_top5_cn_drug_A1, d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_cn_drug_A1_pval

```

###### Test plot
```{r}

d.DeKegel_top5_cn_drug_A1_pval

d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(pval < 0.05) %>%
  group_by(sorted_gene_pair, compound_name) %>%
  summarize(n = n())

d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(pval < 0.05)

d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(pval < 0.05) %>%
  filter(sorted_gene_pair == "ABCB1_ABCB4") %>%
  distinct(compound, .keep_all = TRUE)


```


```{r}

## plot all drugs for one pair
d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(sorted_gene_pair == "ABCB1_ABCB4") %>%
  # filter(pval < 0.05) %>%
  ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~sorted_gene_pair+compound_name, scales = "free_y")


## plot only significant drugs for one pair
d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(sorted_gene_pair == "ABCB1_ABCB4") %>%
  filter(pval < 0.05) %>%
  ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c(1, 4)),
              map_signif_level = FALSE,
              test = "wilcox.test",
              test.args = list(alternative = "greater"),
              textsize = 3.2) +
  scale_y_continuous(expand = expansion(mult = 0.1)) +
  scale_fill_brewer(palette = "YlGnBu", direction = -1) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~sorted_gene_pair+compound_name, scales = "free_y")

```

###### All plots


```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A1_pval <- d.DeKegel_top5_cn_drug_A1_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A1_pval_signif <- d.DeKegel_top5_cn_drug_A1_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A1_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A2_cn_vs_A1_drug_pval_signif_fixed_noFinan.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A1_pval_signif,
#                aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```

I am currently getting the following error for facet_wrap_paginate: `Error: Cannot create zero-length unit vector ("unit" subsetting)`. This seems to be an R v4.0 error, and I'm not sure how to fix it. So as a workaround, I've plotted the remaining plots as a separate file. 
^ I believe I fixed this error by changing the compound/dose labels. It's no longer happening. 



```{r}

## calculate p-vals for drugs targeting A2 vs. A1 CN
# d.DeKegel_top5_cn_drug_A2

d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_summary <- d.DeKegel_top5_cn_drug_A2 %>%
  filter(A1_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A1_cn_bin, alternative = "greater")$p.value) 
# d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_summary

d.DeKegel_top5_cn_drug_A2_pval <- left_join(d.DeKegel_top5_cn_drug_A2, 
                                            d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
# d.DeKegel_top5_cn_drug_A2_pval

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A2_pval <- d.DeKegel_top5_cn_drug_A2_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A2_pval_signif <- d.DeKegel_top5_cn_drug_A2_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A2_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A1_cn_vs_A2_drug_pval_signif_fixed.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A2_pval_signif,
#                aes(x = A1_cn_bin, y = dependency, fill = A1_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()


```

```{r}

d.DeKegel_top5_cn_drug_A2_pval_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKB" | sorted_gene_pair == "AURKA_AURKC") %>%
  filter(compound_name == "danusertib") %>%
  distinct(gene_pair_compound, .keep_all = TRUE)

d.DeKegel_top5_cn_drug_A2_pval_signif %>%
  filter(sorted_gene_pair == "SRPK1_SRPK2") %>%
  filter(compound_name == "SRPIN340") %>%
  distinct(gene_pair_compound, .keep_all = TRUE)

```
There is an issue when one compound is tested at >1 dose. See: AURKA_AURKC and AURKA_AURKB with danusertib. The p-values calculated outside geom_signif() are correct, but the geom_signif() is messed up because facet_wrap_paginate is based on the compound name rather than the compound ID (which contains dose information). Maybe I should try to combine the compound name with the dose. 

^Fixed!

##### K-S test

```{r}

## calculate p-vals for drugs targeting A2 vs. A1 CN
# d.DeKegel_top5_cn_drug_A2

d.DeKegel_top5_cn_drug_A1_vs_cn_A2_ks_pval_summary <- d.DeKegel_top5_cn_drug_A1 %>%
  filter(!is.na(A2_cn_bin)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = kruskal.test(dependency ~ A2_cn_bin)$p.value)
d.DeKegel_top5_cn_drug_A1_vs_cn_A2_ks_pval_summary

d.DeKegel_top5_cn_drug_A1_ks_pval <- left_join(d.DeKegel_top5_cn_drug_A1,
                                                d.DeKegel_top5_cn_drug_A1_vs_cn_A2_ks_pval_summary, 
                                                by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_cn_drug_A1_ks_pval

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A1_ks_pval <- d.DeKegel_top5_cn_drug_A1_ks_pval %>%
  ungroup() %>%
  unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

# d.DeKegel_top5_cn_drug_A1_ks_pval_signif_sens <- d.DeKegel_top5_cn_drug_A1_ks_pval %>%
#   filter(pval < 0.05) %>%
#   group_by(gene_pair_compound, A2_cn_bin) %>%
#   mutate(median_dependency = median(dependency)) %>%
  
# d.DeKegel_top5_cn_drug_A1_ks_pval_signif_sens

# length <- d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   ungroup() %>%
#   distinct(gene_pair_compound_label) %>%
#   nrow()

n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A2_cn_vs_A1_drug_ks_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A1_ks_pval_signif,
#                aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 2, 3, 4)),
#               map_signif_level = FALSE,
#               test = "kruskal.test",
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()


```


I couldn't figure out how to do a K-S test in geom_signif() so I used stat_compare_means() instead, per this site: https://www.r-bloggers.com/2017/06/add-p-values-and-significance-levels-to-ggplots/

```{r}

# d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   filter(gene_pair_compound == "HDAC1_HDAC2_BRD-K13169950-001-14-4::2.5::HTS" | 
#            gene_pair_compound == "HDAC1_HDAC2_BRD-K88742110-001-07-9::2.5::HTS") %>%
#   ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   stat_compare_means(size = 3.25) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap(~gene_pair_compound_label, scales = "free_y",
#              nrow = 3, ncol = 3)
# 
# d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   filter(gene_pair_compound == "HDAC1_HDAC2_BRD-K13169950-001-14-4::2.5::HTS" | 
#            gene_pair_compound == "HDAC1_HDAC2_BRD-K88742110-001-07-9::2.5::HTS") %>%
#   group_by(gene_pair_compound, A2_cn_bin) %>%
#   mutate(group_median = median(dependency)) %>%
#   arrange(gene_pair_compound, A2_cn_bin)
# 
# d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   filter(gene_pair_compound == "HDAC1_HDAC2_BRD-K13169950-001-14-4::2.5::HTS" |
#            gene_pair_compound == "HDAC1_HDAC2_BRD-K88742110-001-07-9::2.5::HTS") %>%
#   group_by(gene_pair_compound, A2_cn_bin) %>%
#   summarize(med_dep = median(dependency))

```

#### Combined CN vs. drug sensitivity
```{r}

# drugs that target A1 or A2 (or both?)

```

# Remove starting here?
##### Make DF
```{r}

## calculate ntiles for combined CN
## updated to fix combined CN calcs 12/3
## old DF: d.DeKegel_top5_druggable_depmap_cn, removed 1/18

## USE THIS ONE INSTEAD!!


d.DeKegel_top5_druggable_depmap_combined_cn <- d.DeKegel_top5_genes_depmap_cn_drug %>%
  mutate(combined_log_cn = log2((2^A1_log_cn) + (2^A2_log_cn))) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_cn_bin = ntile(combined_log_cn, n = 4)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 2, 3, 4)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) #%>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
  # rename(compound_name = name)

d.pairs <- d.DeKegel_top5_druggable_depmap_combined_cn %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

d.pairs
d.drugs

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs <- inner_join(d.pairs, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs

## check for drugs that target both members of a pair
d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n == 1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs <- d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 
d.DeKegel_top5_druggable_depmap_combined_cn
d.drug_pairs

d.DeKegel_top5_combined_cn_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_combined_cn, 
                                                  d.drug_pairs, 
                                                  by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_combined_cn_drug_pair

```



# Remove ending here?


##### WRST
```{r}

d.DeKegel_top5_combined_cn_drug_pair_pval_summary <- d.DeKegel_top5_combined_cn_drug_pair %>%
  filter(combined_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_cn_bin, alternative = "less")$p.value) 
d.DeKegel_top5_combined_cn_drug_pair_pval_summary

d.DeKegel_top5_combined_cn_drug_pair_pval <- left_join(d.DeKegel_top5_combined_cn_drug_pair,
                                                       d.DeKegel_top5_combined_cn_drug_pair_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_cn_drug_pair_pval

```

```{r}

pvals <- d.DeKegel_top5_combined_cn_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

```

##### Add FDR-adjusted p-values to DF
```{r}

d.pvals_labels <- d.DeKegel_top5_combined_cn_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_combined_cn_drug_pair <- d.DeKegel_top5_combined_cn_drug_pair %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_cn_drug_pair

## filtered DF with just FDR < 0.1
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif <- d.DeKegel_top5_combined_cn_drug_pair %>%
  filter(fdr < 0.1)

nrow(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif)
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif

```
The number of rows matches what I calculated above. 


##### Plot

* check how many were significant before I got rid of the Finan step
* print only statistically significant interactions (Bonferroni-corrected)
* print stat sig + CN

###### All pvals

```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_cn_drug_pair_pval <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_cn_drug_pair_pval_signif <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_combined_cn_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_cn_vs_drug_sens_WRST_pval_signif_noFinan.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```
Possibly an error here (the usual `Error: Cannot create zero-length unit vector ("unit" subsetting)`) — investigate!!


###### Top pvals

```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_cn_drug_pair_pval <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_cn_drug_pair_pval_signif <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  filter(pval <= 0.05)

length <- d.DeKegel_top5_combined_cn_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_cn_vs_drug_sens_WRST_pval_L0.05_plus_cn_update3_noFinan.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = combined_log_cn, fill = combined_cn_bin)) +
#     geom_hline(yintercept = 2) +
#     geom_hline(yintercept = log2(3), linetype = "dashed") +
#     geom_hline(yintercept = log2(5), linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "Combined_log_CN") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```


###### FDR signif

Plotting FDR values from DF directly onto ggsignif(): 
https://github.com/const-ae/ggsignif/issues/29
https://cran.r-project.org/web/packages/ggsignif/ggsignif.pdf

```{r}

## plot all FDR < 0.1 pairs (sorted by FDR)
## add my own labels!!

d.DeKegel_top5_combined_cn_drug_pair_fdr_signif <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, fdr),
         "sorted_gene_pair" = reorder(sorted_gene_pair, fdr)) #%>%
  # mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()

d.fdr_labels <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  ungroup() %>%
  dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_cn_vs_drug_sens_WRST_fdr_signif_plus_cn_update3_noFinan.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less", p.adjust.method = "BH"),
#               # annotations = fdr_labels, # fix this to get FDR plotted direclty
#               textsize = 3.2) +
#   # add_pvalue(d.fdr_labels) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif,
#                aes(x = combined_cn_bin, y = (2^combined_log_cn), fill = combined_cn_bin)) +
#     geom_hline(yintercept = 4) +
#     geom_hline(yintercept = 3, linetype = "dashed") +
#     geom_hline(yintercept = 5, linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "Combined_CN") +
#   coord_trans(y = "log2") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```

```{r}

## calculate difference in mean/median dependency between Q1 and Q4 
## log2 fold change or not???
## make volcano plot of that vs. FDR
d.DeKegel_top5_combined_cn_drug_pair 

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr <- d.DeKegel_top5_combined_cn_drug_pair %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>% # get only bins 1 & 4; update to min & max
  group_by(sorted_gene_pair, compound, combined_cn_bin) %>%
  mutate(median_dependency = median(dependency)) %>%
  dplyr::select(prediction_rank:top_5_SL_all_screens, combined_cn_bin, compound, 
                compound_name:moa, median_dependency, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound, combined_cn_bin)), .keep_all = TRUE) %>%
  ungroup()
d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr%>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n())
  # pivot_wider(names_from = combined_cn_bin,
  #             names_glue = "Q{combined_cn_bin}_{.value}",
  #             values_from = dependency)
  # group_by(sorted_gene_pair, compound) %>%
  # summarize()

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide <- d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr %>%
  # group_by(sorted_gene_pair, compound) %>%
  pivot_wider(id_cols = c(sorted_gene_pair, compound, gene_pair_compound_label,
                          compound_name, moa, fdr), 
              names_from = combined_cn_bin, 
              names_glue = "Q{combined_cn_bin}_{.value}",
              values_from = median_dependency) %>%
  mutate(lfc_dependency_Q1_v_Q4 = Q1_median_dependency - Q4_median_dependency)
d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide

```

```{r}

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide %>%
  filter(fdr < 0.1)

d.phase1_cn_volcano_plot <- d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide %>%
  filter(lfc_dependency_Q1_v_Q4 < 0) %>%
  unite(c(sorted_gene_pair, compound_name), col = new_label, sep = "\n", remove = FALSE)

phase1_cn_labels <- d.phase1_cn_volcano_plot %>%
  filter(fdr < 0.1) %>%
  pull(new_label)

ggplot(d.phase1_cn_volcano_plot, aes(x = lfc_dependency_Q1_v_Q4, y = -log10(fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.phase1_cn_volcano_plot$fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = subset(d.phase1_cn_volcano_plot, fdr < 0.1),
                   aes(label = phase1_cn_labels), 
                   segment.size = 0.2,
                   force = 0.5,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_cn_drug_pair_median_dependency_lfc_fdr_volcano_plot.pdf"),
#        width = 6, height = 4, useDingbats = FALSE)

```

useful geom_text_repel and geom_label_repel examples: https://ggrepel.slowkow.com/articles/examples.html

##### Phase 2 for validation

###### Make DF
```{r}

## combine DFs 
# d.DeKegel_top5_druggable_depmap_combined_cn
# d.drug_pairs

## select FDR < 0.1 only, remove ::, get unique gene pair/compound info => pull out of secondary screen
# d.DeKegel_top5_combined_cn_drug_pair
# d.Broad_secondary_auc
# 
# d.DeKegel_top5_combined_cn_drug_pair_fdr_signif 

```


```{r}

d.combined_cn_FDR_signif <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  distinct(across(c(sorted_gene_pair, compound)))
d.combined_cn_FDR_signif

combined_cn_FDR_signif_drugs <- d.combined_cn_FDR_signif %>%
  # dplyr::select(compound) %>%
  separate(col = compound, into = c("id", "dose", "other"), sep = "::") %>%
  dplyr::select(sorted_gene_pair, id) %>%
  distinct() %>%
  pull(id)
combined_cn_FDR_signif_drugs

## get relevant columns from AUC df
d.tmp2 <- d.Broad_secondary_auc %>%
  dplyr::select(broad_id, depmap_id, auc) %>%
  rename(compound_id = broad_id)
d.tmp2

## combine with CN df
d.tmp1 <- d.DeKegel_top5_combined_cn_drug_pair %>%
  dplyr::select(prediction_rank, prediction_percentile, sorted_gene_pair:gene_name,
                compound, compound_name, moa) %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(depmap_id, sorted_gene_pair, compound_id)), .keep_all = TRUE)
d.tmp1
## 1,173,337 rows => 1,173,337 rows ??

## join CN info with secondary AUC data

# d.tmp1
# d.tmp2

d.DeKegel_top5_depmap_combined_cn_phase2_drug <- right_join(d.tmp1, d.tmp2, by = c("depmap_id", "compound_id")) %>%
  filter(!is.na(auc)) %>%
  ungroup() %>%
  unite("gene_pair_compound_label", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE)
d.DeKegel_top5_depmap_combined_cn_phase2_drug

```



```{r}

## WRST => add p-val to DF
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_summary <- d.DeKegel_top5_depmap_combined_cn_phase2_drug %>%
  filter(combined_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound_id) %>%
  summarize("pval" = wilcox.test(auc ~ combined_cn_bin, alternative = "less")$p.value)
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_summary

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval <- left_join(d.DeKegel_top5_depmap_combined_cn_phase2_drug, 
                                                                d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_summary, 
                                                                by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval

```

```{r}

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval %>%
  distinct(gene_pair_compound_label, .keep_all = TRUE) %>%
  arrange(pval)

d.drug_pair_fdr_signif_phase1 <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(sorted_gene_pair, compound_id)))
d.drug_pair_fdr_signif_phase1

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 <- semi_join(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval, d.drug_pair_fdr_signif_phase1,
          by = c("sorted_gene_pair", "compound_id"))

```

```{r}

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1


pvals <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

d.pvals_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound_id) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1

## filtered DF with just FDR < 0.1
# d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1_fdr_signif_phase2 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   filter(fdr < 0.1)

# nrow(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif)
# d.DeKegel_top5_combined_cn_drug_pair_fdr_signif

```


###### Plot

```{r}

## plot all FDR < 0.1 pairs (sorted by FDR)
## add my own labels!!

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval)) #%>%
  # mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()

# d.fdr_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   ungroup() %>%
#   dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_cn_bin, y = auc, fill = combined_cn_bin)) +
#     # geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less", p.adjust.method = "BH"),
#               # annotations = fdr_labels, # fix this to get FDR plotted direclty
#               textsize = 3.2) +
#   # add_pvalue(d.fdr_labels) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "Dose_response_AUC") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_cn_bin, y = (2^combined_log_cn), fill = combined_cn_bin)) +
#     geom_hline(yintercept = 4) +
#     geom_hline(yintercept = 3, linetype = "dashed") +
#     geom_hline(yintercept = 5, linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "Combined_CN") +
#   coord_trans(y = "log2") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```


```{r}

## get FDR from phase 1, p-val from Phase 2 (adjust for 20 tests?)
# d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%

## adjust p-vals
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1
d.tmp1 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  dplyr::select(gene_pair_compound_label, sorted_gene_pair, compound_id, compound_name, moa, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase2_fdr = fdr)
d.tmp1

## plot scatterplot of drug/gene pair FDR correlation
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif
d.tmp2 <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose_rm", "null"), sep = "::") %>%
  dplyr::select(-c(dose_rm, null)) %>%
  dplyr::select(sorted_gene_pair, compound_id, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase1_fdr = fdr)
d.tmp2

d.combined_cn_phase1_fdr_signif_v_phase2_fdr <- left_join(d.tmp1, d.tmp2, 
                                                          by = c("sorted_gene_pair", "compound_id"))
d.combined_cn_phase1_fdr_signif_v_phase2_fdr

```


```{r}

d.combined_cn_phase1_fdr_signif_v_phase2_fdr
d.combined_cn_phase1_fdr_signif_v_phase2_fdr %>%
  filter(phase2_fdr < 0.1)

# d.phase1_cn_volcano_plot <- d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide %>%
#   filter(lfc_dependency_Q1_v_Q4 < 0) %>%
#   unite(c(sorted_gene_pair, compound_name), col = new_label, sep = "\n", remove = FALSE)

phase1_v_phase2_cn_fdr_labels <- d.combined_cn_phase1_fdr_signif_v_phase2_fdr %>%
  pull(gene_pair_compound_label)

ggplot(d.combined_cn_phase1_fdr_signif_v_phase2_fdr, aes(x = -log10(phase1_fdr), y = -log10(phase2_fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  # geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.combined_cn_phase1_fdr_signif_v_phase2_fdr$phase2_fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = d.combined_cn_phase1_fdr_signif_v_phase2_fdr,
                   aes(label = gene_pair_compound_label), 
                   segment.size = 0.2,
                   force = 1,
                   nudge_x = 0.5,
                   nudge_y = 0.5,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_cn_drug_pair_phase1_fdr_v_phase2_fdr.pdf"),
#        width = 4.5, height = 4.5, useDingbats = FALSE)


```



#### Lung only (comb. CN)
```{r}

## calculate ntiles for combined CN

d.DeKegel_top5_druggable_depmap_cn

d.DeKegel_top5_druggable_depmap_cn %>%
  filter(lineage == "lung")

d.DeKegel_top5_druggable_depmap_lung_combined_cn <- d.DeKegel_top5_druggable_depmap_cn %>%
  filter(lineage == "lung") %>%
  mutate(combined_log_cn = A1_log_cn + A2_log_cn) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_cn_bin = ntile(combined_log_cn, n = 4)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(4, 3, 2, 1)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) #%>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
  #rename(compound_name = name)

d.pairs_lung <- d.DeKegel_top5_druggable_depmap_lung_combined_cn %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs_lung <- inner_join(d.pairs_lung, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs_lung

## check for drugs that target both members of a pair
d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs_lung <- d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 
# d.DeKegel_top5_druggable_depmap_combined_cn
# d.drug_pairs

d.DeKegel_top5_lung_combined_cn_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_lung_combined_cn, 
                                                       d.drug_pairs_lung, 
                                                       by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_lung_combined_cn_drug_pair

```


##### WRST
```{r}

d.DeKegel_top5_lung_combined_cn_drug_pair_pval_summary <- d.DeKegel_top5_lung_combined_cn_drug_pair %>%
  filter(combined_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_cn_bin, alternative = "greater")$p.value) 
d.DeKegel_top5_lung_combined_cn_drug_pair_pval_summary

d.DeKegel_top5_lung_combined_cn_drug_pair_pval <- left_join(d.DeKegel_top5_lung_combined_cn_drug_pair,
                                                            d.DeKegel_top5_lung_combined_cn_drug_pair_pval_summary, 
                                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_lung_combined_cn_drug_pair_pval

```

##### Plot
```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_lung_combined_cn_drug_pair_pval <- d.DeKegel_top5_lung_combined_cn_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_lung_combined_cn_drug_pair_pval_signif <- d.DeKegel_top5_lung_combined_cn_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_lung_combined_cn_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_lung_combined_cn_vs_drug_sens_WRST_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```

#### CN vs. drug resistance
```{r}

d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_resist_summary <- d.DeKegel_top5_cn_drug_A1 %>%
  filter(A2_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A2_cn_bin, alternative = "less")$p.value) 
d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_resist_summary %>%
  arrange(pval)

d.DeKegel_top5_cn_drug_A1_pval_resist <- left_join(d.DeKegel_top5_cn_drug_A1, d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_resist_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_cn_drug_A1_pval_resist %>%
  arrange(pval)

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A1_pval_resist <- d.DeKegel_top5_cn_drug_A1_pval_resist %>% 
  ungroup() %>%
  unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A1_pval_resist_signif <- d.DeKegel_top5_cn_drug_A1_pval_resist %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A1_pval_resist_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A2_cn_vs_A1_drug_pval_resist_WRST_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A1_pval_resist_signif,
#                aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```



```{r}

## calculate p-vals for drugs targeting A2 vs. A1 CN
# d.DeKegel_top5_cn_drug_A2

d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_resist_summary <- d.DeKegel_top5_cn_drug_A2 %>%
  filter(A1_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A1_cn_bin, alternative = "less")$p.value) 

d.DeKegel_top5_cn_drug_A2_pval_resist <- left_join(d.DeKegel_top5_cn_drug_A2, d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_resist_summary, 
                                            by = c("sorted_gene_pair", "compound"))
# d.DeKegel_top5_cn_drug_A2_pval

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A2_pval_resist <- d.DeKegel_top5_cn_drug_A2_pval_resist %>% 
  ungroup() %>%
  unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A2_pval_resist_signif <- d.DeKegel_top5_cn_drug_A2_pval_resist %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A2_pval_resist_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A1_cn_vs_A2_drug_pval_resist_WRST_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A2_pval_resist_signif,
#                aes(x = A1_cn_bin, y = dependency, fill = A1_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()


```
NOTE: last 3 on are cut off (but it's probably fine)


### Overall trends
```{r}

# write_rds(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1,
#           file.path(out_dir, "d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1"))
# write_rds(d.combined_cn_phase1_fdr_signif_v_phase2_fdr,
#           file.path(out_dir, "d.combined_cn_phase1_fdr_signif_v_phase2_fdr"))

d.combined_cn_phase1_fdr_signif_v_phase2_fdr

d.DeKegel_top5_combined_cn_drug_pair_fdr_signif
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKC" & compound_name == "PF-03814735") %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>%
  group_by(combined_cn_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.AURKA_AURKC_CN_plot <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKC" & compound_name == "PF-03814735") %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>%
  group_by(combined_cn_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.add_rows <- tibble(combined_cn_bin = c(4, 1, 4, 1),
                   lineage = c("fibroblast", "liver", "peripheral_nervous_system", "thyroid"),
                   n = c(0, 0, 0, 0), 
                   percent = c(0, 0, 0, 0)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 4)))

d.AURKA_AURKC_CN_plot <- bind_rows(d.AURKA_AURKC_CN_plot, d.add_rows)


ggplot(d.AURKA_AURKC_CN_plot, aes(x = lineage, y = percent, fill = combined_cn_bin)) +
  geom_bar(stat = "identity", 
           position = position_dodge(0.9),
           width = 0.8,
           color = "black",
           size = 0.25) +
    # scale_fill_brewer(palette = "YlGnBu") +
    scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"),
                      labels = c("1" = "lowest", "4" = "highest")) +
    theme_bw() +
    theme(aspect.ratio = 0.5,
          axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
          axis.text = element_text(color = "black"),
          axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "AURKA_AURKC_CN_bins_1_and_4_vs_lineage.pdf"),
#        height = 4, width = 8, useDingbats = FALSE)

```
