---
title: "pgPEN_DeKegel_comparison"
author: "Phoebe Parrish"
date: "2022-01-07"
output: html_document
---

## To Do
* update depmap version - use more recent data (I am currently using 19Q1)
* CN as continuous variable, look at outliers (not top 2 quartiles)

## Setup

```{r setup, include=FALSE}

library(biomaRt)
library(depmap)
library(ExperimentHub)
library(tidyverse)
library(ggrepel)
library(ggforce)
library(ggsignif)
library(RColorBrewer)
library(ggpubr) # another way to do significance bars
library(ggprism) # another significance bar package...

```


### Assign variables
```{r}

date <- Sys.Date()

## work laptop
base_dir <- file.path("/Users", "pparrish", "Google_Drive", "01_Research", "01_Projects", "01_Paralog_pgRNA",
                      "01_Data", "Paralog_SL_meta_analysis")

## personal laptop
# base_dir <- file.path("/Users", "phoebeparrish", "Google_Drive", "01_Research", "01_Projects", "01_Paralog_pgRNA",
#                       "01_Data", "Paralog_SL_meta_analysis")

in_dir <- file.path(base_dir, "01_input_files")

out_dir <- file.path(base_dir, "02_output_files")


```


### Import files

```{r, message = FALSE}

d.DeKegel <- read_csv(file.path(in_dir, "DeKegel_Table_S8.csv"))

d.Parrish <- read_rds(file.path(in_dir, "d.PC9_v_HeLa_paralog_target_GI_wide_flag"))

d.Dede <- read_tsv(file.path(in_dir, "Dede_Table_S2.txt"))

d.druggable <- read_tsv(file.path(in_dir, "finan_druggability_with_ensembl_id.txt"))

d.Broad_drug_info <- read_csv(file.path(in_dir, "primary-screen-replicate-collapsed-treatment-info.csv"))

d.Broad_secondary_auc <- read_csv(file.path(in_dir, "secondary-screen-dose-response-curve-parameters.csv"))

d.Broad_secondary_doses <- read_csv(file.path(in_dir, "secondary-screen-dose-response-curve-parameters.csv"))

```



```{r}

## 21Q2 datasets
metadata <- read_rds(file.path(out_dir, "d.metadata_21Q2"))
d.expr_top5 <- read_rds(file.path(out_dir, "d.expr_21Q2_DeKegel_top5"))
d.expr_top5_drug <- read_rds(file.path(out_dir, "d.expr_21Q2_DeKegel_top5_druggable"))
d.cn_top5 <- read_rds(file.path(out_dir, "d.cn_21Q2_DeKegel_top5"))
d.cn_top5_drug <- read_rds(file.path(out_dir, "d.cn_21Q2_DeKegel_top5_druggable"))
d.mut_top5 <- read_rds(file.path(out_dir, "d.mut_21Q2_DeKegel_top5"))
d.mut_top5_drug <- read_rds(file.path(out_dir, "d.mut_21Q2_DeKegel_top5_druggable"))

## 19Q3 datasets
drug_metadata <- read_rds(file.path(out_dir, "d.metadata_19Q3"))
d.drug_sens_filtered <- read_rds(file.path(out_dir, "d.drug_sens_19Q3_DeKegel_top5_druggable"))

```

## Analysis


#### Combined expr vs. drug sensitivity

##### Make DFs
# replace d.DeKegel_top5_druggable w/ d.DeKegel_top5_genes_depmap_expr

```{r}

d.tmp1 <- d.DeKegel_top5_druggable %>%
  dplyr::select(prediction_rank:depmap_hit, A1_drug_tier:druggable_flag)

d.tmp2 <- d.expr_top5_drug %>%
  dplyr::select(depmap_id, rna_expression, entrez_id)

d.tmp3 <- metadata %>%
  dplyr::select(depmap_id, stripped_cell_line_name, primary_disease, subtype_disease,
                lineage, lineage_subtype) %>%
  rename(cell_line = stripped_cell_line_name)

d.DeKegel_top5_druggable_depmap_expr <- d.tmp1 %>%
  ## add gene 1 RNA expr info
  left_join(d.tmp2, by = c("A1_entrez" = "entrez_id")) %>%
  rename(A1_rna_expr = rna_expression) %>%
  ## add gene 2 RNA expr info
  left_join(d.tmp2, by = c("depmap_id" = "depmap_id", "A2_entrez" = "entrez_id")) %>%
  rename(A2_rna_expr = rna_expression) %>%
  ## add cell line info
  left_join(d.tmp3, by = "depmap_id")
d.DeKegel_top5_druggable_depmap_expr

```


```{r}

## calculate ntiles for combined CN

d.DeKegel_top5_druggable_depmap_combined_expr <- d.DeKegel_top5_druggable_depmap_expr %>%
  # mutate(combined_expr = A1_rna_expr + A2_rna_expr) %>%
  mutate(combined_expr = log2((2^A1_rna_expr) + (2^A2_rna_expr))) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_expr_bin = ntile(combined_expr, n = 4)) %>%
  mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(1, 2, 3, 4)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target)# %>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
 # rename(compound_name = name)

d.pairs <- d.DeKegel_top5_druggable_depmap_combined_expr %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

d.pairs
d.drugs

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs <- inner_join(d.pairs, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs

## check for drugs that target both members of a pair
d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs <- d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 

d.DeKegel_top5_combined_expr_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_combined_expr, 
                                                  d.drug_pairs, 
                                                  by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_combined_expr_drug_pair

```


##### WRST
```{r}

d.DeKegel_top5_combined_expr_drug_pair_pval_summary <- d.DeKegel_top5_combined_expr_drug_pair %>%
  filter(combined_expr_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_expr_bin, alternative = "less")$p.value) 
d.DeKegel_top5_combined_expr_drug_pair_pval_summary

d.DeKegel_top5_combined_expr_drug_pair_pval <- left_join(d.DeKegel_top5_combined_expr_drug_pair,
                                                       d.DeKegel_top5_combined_expr_drug_pair_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_expr_drug_pair_pval

```

##### Add FDR-adjusted p-values to DF

```{r}

pvals <- d.DeKegel_top5_combined_expr_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

d.pvals_labels <- d.DeKegel_top5_combined_expr_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_combined_expr_drug_pair <- d.DeKegel_top5_combined_expr_drug_pair %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_expr_drug_pair

## filtered DF with just FDR < 0.1
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif <- d.DeKegel_top5_combined_expr_drug_pair %>%
  filter(fdr < 0.1)

nrow(d.DeKegel_top5_combined_expr_drug_pair_fdr_signif)
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif

```


##### Plot
```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_expr_drug_pair_pval <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_expr_drug_pair_pval_signif <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_combined_expr_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_expr_vs_drug_sens_WRST_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

```


```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_expr_drug_pair_pval <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_expr_drug_pair_pval_signif <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  filter(pval <= 0.005)

length <- d.DeKegel_top5_combined_expr_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_expr_fixed_vs_drug_sens_WRST_pval_signif_plus_expr_pL0.005.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(x = "Combined_expr_bin",
#          y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = combined_expr, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(x = "Combined_expr_bin", 
#          y = "Combined_expression") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```

###### FDR signif

```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, fdr),
         "sorted_gene_pair" = reorder(sorted_gene_pair, fdr)) #%>%
  # mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_expr_fixed_vs_drug_sens_WRST_pval_signif_plus_expr_fdrL0.1.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_fdr_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_expr_drug_pair_fdr_signif,
#                aes(x = combined_expr_bin, y = combined_expr, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "Combined_expression") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```


```{r}

## calculate difference in mean/median dependency between Q1 and Q4 
## log2 fold change or not???
## make volcano plot of that vs. FDR
d.DeKegel_top5_combined_expr_drug_pair 

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr <- d.DeKegel_top5_combined_expr_drug_pair %>%
  filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>% # get only bins 1 & 4; update to min & max
  group_by(sorted_gene_pair, compound, combined_expr_bin) %>%
  mutate(median_dependency = median(dependency)) %>%
  dplyr::select(prediction_rank:depmap_hit, combined_expr_bin, compound, 
                compound_name:moa, median_dependency, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound, combined_expr_bin)), .keep_all = TRUE) %>%
  ungroup()
d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr%>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n())
  # pivot_wider(names_from = combined_cn_bin,
  #             names_glue = "Q{combined_cn_bin}_{.value}",
  #             values_from = dependency)
  # group_by(sorted_gene_pair, compound) %>%
  # summarize()

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide <- d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr %>%
  # group_by(sorted_gene_pair, compound) %>%
  pivot_wider(id_cols = c(sorted_gene_pair, compound, gene_pair_compound_label,
                          compound_name, moa, fdr), 
              names_from = combined_expr_bin, 
              names_glue = "Q{combined_expr_bin}_{.value}",
              values_from = median_dependency) %>%
  mutate(lfc_dependency_Q1_v_Q4 = Q1_median_dependency - Q4_median_dependency)
d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide

```

```{r}

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide %>%
  filter(fdr < 0.1)

d.phase1_expr_volcano_plot <- d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide %>%
  filter(lfc_dependency_Q1_v_Q4 < 0) %>%
  unite(c(sorted_gene_pair, compound_name), col = new_label, sep = "\n", remove = FALSE)

phase1_expr_labels_1 <- d.phase1_expr_volcano_plot %>%
  filter(fdr < 0.1 & fdr >= 0.01) %>%
  pull(new_label)

phase1_expr_labels_2 <- d.phase1_expr_volcano_plot %>%
  filter(fdr < 0.01) %>%
  pull(new_label)

ggplot(d.phase1_expr_volcano_plot, aes(x = lfc_dependency_Q1_v_Q4, y = -log10(fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.phase1_expr_volcano_plot$fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = subset(d.phase1_expr_volcano_plot, fdr < 0.1 & fdr >= 0.01),
                   aes(label = phase1_expr_labels_1), 
                   segment.size = 0.2,
                   force = 1,
                   direction = "both",
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  geom_label_repel(data = subset(d.phase1_expr_volcano_plot, fdr < 0.01),
                   aes(label = phase1_expr_labels_2), 
                   segment.size = 0.2,
                   force = 0.5,
                   direction = "both",
                   # nudge_y = -0.5, 
                   nudge_x = 0.1,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_expr_drug_pair_median_dependency_lfc_fdr_volcano_plot.pdf"),
#        width = 6, height = 4, useDingbats = FALSE)

```

#### Phase 2 combined expr
```{r}

d.combined_expr_FDR_signif <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  distinct(across(c(sorted_gene_pair, compound)))
d.combined_expr_FDR_signif

combined_expr_FDR_signif_drugs <- d.combined_expr_FDR_signif %>%
  # dplyr::select(compound) %>%
  separate(col = compound, into = c("id", "dose", "other"), sep = "::") %>%
  dplyr::select(sorted_gene_pair, id) %>%
  distinct() %>%
  pull(id)
combined_expr_FDR_signif_drugs

## get relevant columns from AUC df
d.tmp2 <- d.Broad_secondary_auc %>%
  dplyr::select(broad_id, depmap_id, auc) %>%
  rename(compound_id = broad_id)
d.tmp2

## combine with CN df
d.tmp1 <- d.DeKegel_top5_combined_expr_drug_pair %>%
  dplyr::select(prediction_rank, prediction_percentile, sorted_gene_pair:gene_name,
                compound, compound_name, moa) %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(depmap_id, sorted_gene_pair, compound_id)), .keep_all = TRUE)
d.tmp1
## 1,173,337 rows => 1,173,337 rows ??

## join CN info with secondary AUC data

# d.tmp1
# d.tmp2

d.DeKegel_top5_depmap_combined_expr_phase2_drug <- right_join(d.tmp1, d.tmp2, by = c("depmap_id", "compound_id")) %>%
  filter(!is.na(auc)) %>%
  ungroup() %>%
  unite("gene_pair_compound_label", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE)
d.DeKegel_top5_depmap_combined_expr_phase2_drug

```



```{r}

## WRST => add p-val to DF
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_summary <- d.DeKegel_top5_depmap_combined_expr_phase2_drug %>%
  filter(combined_expr_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound_id) %>%
  summarize("pval" = wilcox.test(auc ~ combined_expr_bin, alternative = "less")$p.value)
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_summary

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval <- left_join(d.DeKegel_top5_depmap_combined_expr_phase2_drug, 
                                                                d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_summary, 
                                                                by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval

```

```{r}

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval %>%
  distinct(gene_pair_compound_label, .keep_all = TRUE) %>%
  arrange(pval)

d.drug_pair_expr_fdr_signif_phase1 <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(sorted_gene_pair, compound_id)))
d.drug_pair_expr_fdr_signif_phase1

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 <- semi_join(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval, d.drug_pair_expr_fdr_signif_phase1,
          by = c("sorted_gene_pair", "compound_id"))

```

```{r}

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1


pvals <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

d.pvals_labels <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound_id) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1


```

###### Plot

```{r}

## plot all FDR < 0.1 pairs (sorted by FDR)
## add my own labels!!

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval)) #%>%
  # mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()

# d.fdr_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   ungroup() %>%
#   dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_expr_bin, y = auc, fill = combined_expr_bin)) +
#     # geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less", p.adjust.method = "BH"),
#               # annotations = fdr_labels, # fix this to get FDR plotted direclty
#               textsize = 3.2) +
#   # add_pvalue(d.fdr_labels) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "Dose_response_AUC") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_expr_bin, y = combined_expr, fill = combined_expr_bin)) +
#     # geom_hline(yintercept = 4) +
#     # geom_hline(yintercept = 3, linetype = "dashed") +
#     # geom_hline(yintercept = 5, linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "Combined_expr") +
#   coord_trans(y = "log2") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```

```{r}

## get FDR from phase 1, p-val from Phase 2 (adjust for 20 tests?)
# d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%

## adjust p-vals
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1
d.tmp1 <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  dplyr::select(gene_pair_compound_label, sorted_gene_pair, compound_id, compound_name, moa, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase2_fdr = fdr)
d.tmp1

## plot scatterplot of drug/gene pair FDR correlation
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif
d.tmp2 <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose_rm", "null"), sep = "::") %>%
  dplyr::select(-c(dose_rm, null)) %>%
  dplyr::select(sorted_gene_pair, compound_id, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase1_fdr = fdr)
d.tmp2

d.combined_expr_phase1_fdr_signif_v_phase2_fdr <- left_join(d.tmp1, d.tmp2, 
                                                          by = c("sorted_gene_pair", "compound_id"))
d.combined_expr_phase1_fdr_signif_v_phase2_fdr

```


```{r}

d.combined_expr_phase1_fdr_signif_v_phase2_fdr

d.combined_expr_phase1_fdr_signif_v_phase2_fdr %>%
  filter(phase2_fdr < 0.1)

phase1_v_phase2_expr_fdr_labels <- d.combined_expr_phase1_fdr_signif_v_phase2_fdr %>%
  pull(gene_pair_compound_label)

ggplot(d.combined_expr_phase1_fdr_signif_v_phase2_fdr, aes(x = -log10(phase1_fdr), y = -log10(phase2_fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  # geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.combined_expr_phase1_fdr_signif_v_phase2_fdr$phase2_fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = d.combined_expr_phase1_fdr_signif_v_phase2_fdr,
                   aes(label = gene_pair_compound_label), 
                   segment.size = 0.2,
                   force = 1,
                   nudge_x = 0.5,
                   nudge_y = 0.5,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_expr_drug_pair_phase1_fdr_v_phase2_fdr.pdf"),
#        width = 4.5, height = 4.5, useDingbats = FALSE)


```

```{r}


# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_expr_drug_pair_phase1_fdr_v_phase2_fdr_lineage.pdf"),
#        width = 6, height = (3*15), useDingbats = FALSE)

length <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  ungroup() %>%
  distinct(sorted_gene_pair) %>%
  nrow()

# d.fdr_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   ungroup() %>%
#   dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1_lineage.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   print(
#     d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
#     filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
#     ggplot(aes(x = lineage, fill = combined_expr_bin)) +
#     geom_bar(aes(y = (..count..)/sum(..count..)), 
#                    position = position_dodge(0.9), 
#                    width = 0.8,
#                    color = "black", 
#                    size = 0.25) +
#     # scale_fill_brewer(palette = "YlGnBu") +
#     scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"), 
#                       labels = c("1" = "lowest", "4" = "highest")) +
#     theme_bw() +
#     theme(aspect.ratio = 0.5,
#           axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
#           axis.text = element_text(color = "black"),
#           axis.ticks = element_line(color = "black")) +
#     facet_wrap_paginate(~sorted_gene_pair, scales = "free", ncol = 1, nrow = 1, page = i)
#   )
# }
# dev.off()

```

```{r}

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  # filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n = n())

d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n = n())

d.DeKegel_top5_druggable_depmap_combined_expr %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n =  n())

d.DeKegel_top5_combined_expr_drug_pair %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n = n())

```

### Overall trends
```{r}

# write_rds(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1,
#           file.path(out_dir, "d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1"))
# write_rds(d.combined_cn_phase1_fdr_signif_v_phase2_fdr,
#           file.path(out_dir, "d.combined_cn_phase1_fdr_signif_v_phase2_fdr"))

d.combined_cn_phase1_fdr_signif_v_phase2_fdr

d.DeKegel_top5_combined_cn_drug_pair_fdr_signif
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKC" & compound_name == "PF-03814735") %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>%
  group_by(combined_cn_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.AURKA_AURKC_CN_plot <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKC" & compound_name == "PF-03814735") %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>%
  group_by(combined_cn_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.add_rows <- tibble(combined_cn_bin = c(4, 1, 4, 1),
                   lineage = c("fibroblast", "liver", "peripheral_nervous_system", "thyroid"),
                   n = c(0, 0, 0, 0), 
                   percent = c(0, 0, 0, 0)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 4)))

d.AURKA_AURKC_CN_plot <- bind_rows(d.AURKA_AURKC_CN_plot, d.add_rows)


ggplot(d.AURKA_AURKC_CN_plot, aes(x = lineage, y = percent, fill = combined_cn_bin)) +
  geom_bar(stat = "identity", 
           position = position_dodge(0.9),
           width = 0.8,
           color = "black",
           size = 0.25) +
    # scale_fill_brewer(palette = "YlGnBu") +
    scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"),
                      labels = c("1" = "lowest", "4" = "highest")) +
    theme_bw() +
    theme(aspect.ratio = 0.5,
          axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
          axis.text = element_text(color = "black"),
          axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "AURKA_AURKC_CN_bins_1_and_4_vs_lineage.pdf"),
#        height = 4, width = 8, useDingbats = FALSE)

```


```{r}

d.combined_expr_phase1_fdr_signif_v_phase2_fdr
  
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif

# write_rds(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1, 
#           file.path(out_dir, "d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1"))
# write_rds(d.combined_expr_phase1_fdr_signif_v_phase2_fdr, 
#           file.path(out_dir, "d.combined_expr_phase1_fdr_signif_v_phase2_fdr"))

d.ABL1_ABL2_expr_plot <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "ABL1_ABL2" & compound_name == "saracatinib") %>%
  filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
  group_by(combined_expr_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.add_rows <- tibble(combined_cn_bin = c(1, 1, 1, 4, 1, 1),
                   lineage = c("bone", "fibroblast", "peripheral_nervous_system", "prostate", "skin", "thyroid"),
                   n = c(0, 0, 0, 0, 0, 0), 
                   percent = c(0, 0, 0, 0, 0, 0)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 4)))

d.ABL1_ABL2_expr_plot <- bind_rows(d.ABL1_ABL2_expr_plot, d.add_rows)

ggplot(d.ABL1_ABL2_expr_plot, aes(x = lineage, y = percent, fill = combined_expr_bin)) +
  geom_bar(stat = "identity",
           position = position_dodge(0.9),
           width = 0.8,
           color = "black",
           size = 0.25) +
    # scale_fill_brewer(palette = "YlGnBu") +
    scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"),
                      labels = c("1" = "lowest", "4" = "highest")) +
    theme_bw() +
    theme(aspect.ratio = 0.5,
          axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
          axis.text = element_text(color = "black"),
          axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "ABL1_ABL2_expr_bins_1_and_4_vs_lineage.pdf"),
#        height = 4, width = 8, useDingbats = FALSE)

```

```{r}

d.FYN_SRC_expr_plot <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "FYN_SRC" & compound_name == "vandetanib") %>%
  filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
  group_by(combined_expr_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.add_rows <- tibble(combined_cn_bin = c(1, 1, 4, 1),
                   lineage = c("fibroblast", "peripheral_nervous_system", "prostate", "skin"),
                   n = c(0, 0, 0, 0),
                   percent = c(0, 0, 0, 0)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 4)))

d.FYN_SRC_expr_plot <- bind_rows(d.FYN_SRC_expr_plot, d.add_rows)

ggplot(d.FYN_SRC_expr_plot, aes(x = lineage, y = percent, fill = combined_expr_bin)) +
  geom_bar(stat = "identity",
           position = position_dodge(0.9),
           width = 0.8,
           color = "black",
           size = 0.25) +
    # scale_fill_brewer(palette = "YlGnBu") +
    scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"),
                      labels = c("1" = "lowest", "4" = "highest")) +
    theme_bw() +
    theme(aspect.ratio = 0.5,
          axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
          axis.text = element_text(color = "black"),
          axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "FYN_SRC_expr_bins_1_and_4_vs_lineage.pdf"),
#        height = 4, width = 8, useDingbats = FALSE)

```


#### Lung only (comb. expr)
```{r}

## calculate ntiles for combined CN

d.DeKegel_top5_druggable_depmap_lung_combined_expr <- d.DeKegel_top5_druggable_depmap_expr %>%
  filter(lineage == "lung") %>%
  mutate(combined_rna_expr = A1_rna_expr + A2_rna_expr) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_expr_bin = ntile(combined_rna_expr, n = 4)) %>%
  mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(4, 3, 2, 1)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) #%>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
  #rename(compound_name = name)

d.pairs_lung <- d.DeKegel_top5_druggable_depmap_lung_combined_expr %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs_lung <- inner_join(d.pairs_lung, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs_lung

## check for drugs that target both members of a pair
d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs_lung <- d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 
d.DeKegel_top5_lung_combined_expr_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_lung_combined_expr, 
                                                       d.drug_pairs_lung, 
                                                       by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_lung_combined_expr_drug_pair

```


##### WRST
```{r}

d.DeKegel_top5_lung_combined_expr_drug_pair_pval_summary <- d.DeKegel_top5_lung_combined_expr_drug_pair %>%
  filter(combined_expr_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_expr_bin, alternative = "greater")$p.value) 
# d.DeKegel_top5_lung_combined_expr_drug_pair_pval_summary

d.DeKegel_top5_lung_combined_expr_drug_pair_pval <- left_join(d.DeKegel_top5_lung_combined_expr_drug_pair,
                                                            d.DeKegel_top5_lung_combined_expr_drug_pair_pval_summary, 
                                                            by = c("sorted_gene_pair", "compound"))
# d.DeKegel_top5_lung_combined_expr_drug_pair_pval

```

##### Plot
```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_lung_combined_expr_drug_pair_pval <- d.DeKegel_top5_lung_combined_expr_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_lung_combined_expr_drug_pair_pval_signif <- d.DeKegel_top5_lung_combined_expr_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_lung_combined_expr_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))
# 
# pdf(file.path(out_dir, "DeKegel_top5_lung_combined_expr_vs_drug_sens_WRST_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

```




